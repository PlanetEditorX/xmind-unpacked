(global.webpackChunkxmind_vana=global.webpackChunkxmind_vana||[]).push([[5300],{35453:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>o});var i=a(23645),r=a.n(i)()((function(e){return e[1]}));r.push([e.id,".audio-bar {\n  width: 248px;\n  height: 52px;\n  z-index: 1;\n  margin-top: 24px;\n  border-radius: 8px;\n}\n",""]);const o=r},68303:(e,t,a)=>{"use strict";a.d(t,{Z:()=>l});var i=a(75644);const r=(0,a(23352).ZP)("mp3recorder"),o=0,u=1,n=2;const l=class{constructor(e,t){t=t||{},this.sampleRate=t.sampleRate||44100,this.bufferSize=t.bufferSize||4096,this.kbps=t.kbps||128,this._mp3Data=[],this._stream=e,this.state=o,this.isEmpty=!0,this.data=null}start(){if(this.state!==o)return;this.state=u;let e=new(window.AudioContext||window.webkitAudioContext);this._context=e;let t=e.createMediaStreamSource(this._stream);this.audioInput=t,this.encoder=new i.d(1,e.sampleRate,this.kbps||128);let a=e.createScriptProcessor(this.bufferSize,1,1);a.onaudioprocess=e=>{if(this.state===u){let t=e.inputBuffer.getChannelData(0);t.filter((e=>0!==e)).length>0&&(this.isEmpty=!1);for(let e=0;e<t.length;e+=1152){let a=Math.min(t.length-e,1152),i=new ArrayBuffer(2*a),r=new DataView(i),o=0,u=0,n=0;for(;n<a;++n,o+=2)u=Math.max(-1,Math.min(1,t[e+n])),r.setInt16(o,u<0?32768*u:32767*u,!0);let l=this.encoder.encodeBuffer(new Int16Array(r.buffer));l.length>0&&this._mp3Data.push(l)}}},t.connect(a),a.connect(e.destination)}pause(){this.state===u&&(this.state=n)}resume(){this.state===n&&(this.state=u)}stop(){if(this.state===o)return;this.state=o;let e=this.encoder.flush();e.length>0&&this._mp3Data.push(new Int8Array(e)),this.data=new Blob(this._mp3Data,{type:"audio/mp3"}),this.audioInput.disconnect(),this.audioInput=null;try{let e=this._stream.getAudioTracks();for(let t of e)t.stop();this._stream=null}catch(e){r.warn("Error while stopping mp3 recording:",e)}this._context.close(),this._context=null}}},65300:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>_});var i=a(2954),r=a(27049),o=a(87141),u=a(84374),n=a(69931),l=a(23352),s=a(12455);const d=(0,i.aZ)({__name:"audio-player",emits:["error"],setup(e,{emit:t}){const a=(0,i.iH)(null),{audioFilePath:d,audioAutoplay:c,playerTimeString:p,audioPlayerIcon:v,audioPlayerStatus:h,handleClickPlayer:m}=(e=>{const t=(0,l.ZP)("audioBarPlayer"),{getResourceUrlByXapUrl:a,document:d,activeSheetViewerAppearance:c}=(0,u.nZ)(),p=(0,i.iH)(""),v=(0,i.Fl)((()=>{var e;const t=(0,s.r)().isZenMode?(null===(e=c.value)||void 0===e?void 0:e.includes("dark"))?"dark":"default":(0,o.S)().appearance,a="play"===m.value?`audio-pause@${t}`:`audio-play@${t}`;return(0,n.ju)(`static/assets/images/audio/${a}.svg`)})),h=(0,i.iH)("00 : 00 : 00"),m=(0,i.iH)("inti");let g=null,f=0;(0,i.bv)((async()=>{e.value.addEventListener("durationchange",(t=>{e.value.duration!=1/0&&(f=e.value.duration,b(!0))}),!1),e.value.addEventListener("play",(()=>{m.value="play",k("play")})),e.value.addEventListener("pause",(()=>{m.value="pause",k("pause")})),e.value.addEventListener("ended",(()=>{m.value="end",k("ended")})),e.value.addEventListener("error",(a=>{m.value="error",t.debug("Error "+e.value.error.code+"; details: "+e.value.error.message)})),p.value=await y()})),(0,i.Jd)((()=>{S()}));const y=async()=>{const e=d.value.query({id:(0,r.E)().audioTopicId});if(!e)return null;const t=e.asTopic(),i=u.HG.audioNotesFromTopic(t);return i?a(i):null},k=e=>{switch(e){case"play":m.value="play",w(),b();break;case"pause":m.value="pause",S(),b();break;case"ended":m.value="end",S(),b(!0)}},b=t=>{if(e.value){const a=e.value.currentTime;h.value=_(1e3*(t?f:f-a))}},w=()=>{S(),g=window.setInterval((()=>{h.value=_(1e3*(f-e.value.currentTime))}),1e3)},_=e=>{if(Number.isNaN(e)||!Number.isFinite(e)||e<0)return"00 : 00 : 00";let t=Math.floor(e/1e3),a=Math.floor(t/60);t%=60;const i=Math.floor(a/60);return a%=60,`${i.toString().padStart(2,"0")} : ${a.toString().padStart(2,"0")} : ${t.toString().padStart(2,"0")}`},S=()=>{null!==g&&(window.clearInterval(g),g=null)};return(0,i.YP)(d,(()=>{(0,r.E)().audioTopicId&&(d.value.query({id:(0,r.E)().audioTopicId})||(m.value="error"))})),{audioFilePath:p,audioAutoplay:(0,i.Fl)((()=>(0,r.E)().audioAutoplay)),audioPlayerIcon:v,playerTimeString:h,audioPlayerStatus:m,handleClickPlayer:()=>{e.value&&(e.value.paused?e.value.play().catch((()=>{m.value="error"})):e.value.pause())}}})(a);return(0,i.YP)(h,(e=>{"error"===e&&t("error")})),{__sfc:!0,emits:t,audioElement:a,audioFilePath:d,audioAutoplay:c,playerTimeString:p,audioPlayerIcon:v,audioPlayerStatus:h,handleClickPlayer:m}}});var c=a(51900);const p=(0,c.Z)(d,(function(){var e=this,t=e._self._c,a=e._self._setupProxy;return t("div",{staticClass:"uk-flex uk-flex-middle uk-flex-row uk-height-1-1 uk-width-expand uk-margin-left"},[t("button",{staticClass:"vk-button-tile uk-margin-right uk-padding-remove",staticStyle:{background:"transparent"},on:{click:function(e){return a.handleClickPlayer()}}},[t("img",{staticClass:"uk-preserve",staticStyle:{width:"32px",height:"32px"},attrs:{draggable:"false","uk-svg":"",src:a.audioPlayerIcon}})]),e._v(" "),t("div",{staticStyle:{"font-size":"18px"}},[e._v("\n    "+e._s(a.playerTimeString)+"\n  ")]),e._v(" "),t("audio",{ref:"audioElement",attrs:{preload:"auto",autoplay:a.audioAutoplay,src:a.audioFilePath}})])}),[],!1,null,null,null).exports;var v=a(63111),h=a(46016),m=a(18621),g=a(13382),f=a(68303);const y=()=>{const{document:e,activeSheetViewer:t,changeDoc:a,executeAction:l,createXapUrlByArrayBuffer:d}=(0,u.nZ)(),{T:c}=(0,o.JE)(),{updateAudioBarMode:p,updateAudioRecording:y}=(0,r.E)(),k=(0,i.iH)("init"),b=(0,i.iH)("00 : 00 : 00"),w=(0,i.iH)(null);let _="",S=null;const x=(0,i.Fl)((()=>(0,h.$)().editorMode===v.Pq)),A=(0,i.Fl)((()=>"init"===k.value&&"audio_record"===(0,r.E)().audioBarMode&&!P.value)),P=(0,i.Fl)((()=>{const{document:e,selection:t}=(0,u.nZ)();if(x.value)return!0;if(!t.value)return!1;if("init"===k.value){return t.value.modelIds.filter((t=>"topic"===e.value.query({id:t}).type)).length>0}})),T=(0,i.Fl)((()=>{var e;const{activeSheetViewerAppearance:t}=(0,u.nZ)(),a=(0,s.r)().isZenMode?(null===(e=t.value)||void 0===e?void 0:e.includes("dark"))?"dark":"default":(0,o.S)().appearance;let i;switch(k.value){case"recording":i=`audio-stop@${a}`;break;case"recordCompleted":i=`audio-play@${a}`;break;default:i=A.value?"audio-disabled":"audio-default"}return(0,n.ju)(`static/assets/images/audio/${i}.svg`)})),C=()=>{k.value="saving",R(),setTimeout((()=>{b.value="00 : 00 : 00"}),0),y(!1),w.value&&(w.value.stop(),w.value.isEmpty?(l({name:"mutateBatchDirect",payload:[{name:"mutate:finishEditingTitle"},{name:"mutate:selectTopics",payload:{topics:[_]}},{name:"mutate:delete"}]}),k.value="error",(0,g.N0)({type:"error",title:"Recording Failed",message:c("Recording Failed"),detail:c("This could be because that Xmind does not have permission to access microphone or microphone does not work properly."),buttons:[c("OK")]})):(B(w.value.data),k.value="recordCompleted"))};(0,i.bv)((()=>{navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((e=>{w.value=new f.Z(e)})).catch((()=>{k.value="error",(0,g.N0)({type:"error",title:"Xmind",message:c("Audio Note is Disabled"),detail:c("Audio note is disabled because no recorder device is detected."),buttons:[c("OK")]})}))})),(0,i.Jd)((()=>{"recording"===k.value&&C(),R()}));const B=async t=>{var i,r;const o=await t.arrayBuffer();if(o){const t=await d(o,".mp3");setTimeout((()=>{p({audioBarMode:"audio_play",audioTopicId:_,audioAutoplay:!1})}),10);const n=(null===(r=null===(i=e.value.query({id:_}))||void 0===i?void 0:i.asTopic())||void 0===r?void 0:r.title)||"",s=u.HG.changeAudioNotesFor(e.value,_,{title:n,resourcePath:t.substring(4)});s&&a(s.ownerDocument),l({name:"mutateBatchDirect",payload:[{name:"mutate:selectTopics",payload:{topics:[_]}}]})}},M=()=>{R();const e=(new Date).getTime();S=window.setInterval((()=>{b.value=I(Date.now()-e)}),1e3)},R=()=>{null!==S&&(window.clearInterval(S),S=null)},I=e=>{if(Number.isNaN(e)||!Number.isFinite(e)||e<0)return"00 : 00 : 00";let t=Math.floor(e/1e3),a=Math.floor(t/60);t%=60;const i=Math.floor(a/60);a%=60;return`${i.toString().padStart(2,"0")} : ${a.toString().padStart(2,"0")} : ${t.toString().padStart(2,"0")}`};return(0,i.YP)(e,(()=>{if(!_)return;e.value.query({id:_})||(k.value="error")})),{recordTimeString:b,audioRecorderIcon:T,audioRecorderStatus:k,handleClickRecorder:()=>{A.value||("init"===k.value?(async()=>{var e;if(w.value){const a=(new Date).toLocaleString();await l({name:"mutateBatchDirect",payload:[{name:"mutate:insertSubtopicWithTitle",inputValue:a}]});const i=null===(e=t.value)||void 0===e?void 0:e.getViewerState().selection,r=i&&"topics"===i.kind&&i.topics[0];_=r,w.value.start(),k.value="recording",y(!0),M(),(0,m.L9)({eventCategory:"WorkBench",eventAction:"recordAudio"})}})():"recording"===k.value&&C())}}},k=(0,i.aZ)({__name:"audio-recoder",emits:["error"],setup(e,{emit:t}){const{recordTimeString:a,audioRecorderIcon:r,audioRecorderStatus:o,handleClickRecorder:u}=y();return(0,i.YP)(o,(e=>{"error"===e&&t("error")})),{__sfc:!0,emits:t,recordTimeString:a,audioRecorderIcon:r,audioRecorderStatus:o,handleClickRecorder:u}}});const b=(0,c.Z)(k,(function(){var e=this,t=e._self._c,a=e._self._setupProxy;return t("div",{staticClass:"uk-flex uk-flex-middle uk-flex-row uk-height-1-1 uk-width-expand uk-margin-left"},[t("button",{staticClass:"vk-button-tile uk-margin-small-right uk-padding-remove",staticStyle:{background:"transparent"},on:{click:function(e){return a.handleClickRecorder()}}},[t("img",{staticClass:"uk-preserve",staticStyle:{width:"32px",height:"32px"},attrs:{draggable:"false","uk-svg":"",src:a.audioRecorderIcon}})]),e._v(" "),t("div",{staticStyle:{"font-size":"18px"}},[e._v("\n    "+e._s(a.recordTimeString)+"\n  ")])])}),[],!1,null,null,null).exports,w=(0,i.aZ)({__name:"audio-bar",setup(e){const{updateAudioRecording:t,updateAudioBarMode:a}=(0,r.E)(),o=(0,i.Fl)((()=>"audio_record"===(0,r.E)().audioBarMode)),u=()=>{t(!1),a({audioBarMode:""})};return(0,i.Jd)((()=>{u()})),{__sfc:!0,updateAudioRecording:t,updateAudioBarMode:a,isRecodeMode:o,closeAudioBar:u,AudioPlayer:p,AudioRecoder:b}}});a(73215);const _=(0,c.Z)(w,(function(){var e=this,t=e._self._c,a=e._self._setupProxy;return t("div",{staticClass:"uk-position-absolute uk-position-top-center uk-box-shadow-floating uk-background-default audio-bar",staticStyle:{"-webkit-app-region":"no-drag"}},[t("div",{staticClass:"uk-flex uk-flex-middle uk-height-1-1 uk-width-1-1"},[a.isRecodeMode?t(a.AudioRecoder,{on:{error:a.closeAudioBar}}):t(a.AudioPlayer,{on:{error:a.closeAudioBar}}),e._v(" "),t("button",{staticClass:"vk-button-tile uk-margin-right",on:{click:function(e){return a.closeAudioBar()}}},[t("span",{attrs:{"uk-icon":"close"}})])],1)])}),[],!1,null,null,null).exports},73215:(e,t,a)=>{var i=a(35453);i.__esModule&&(i=i.default),"string"==typeof i&&(i=[[e.id,i,""]]),i.locals&&(e.exports=i.locals);(0,a(45346).Z)("62a99fc4",i,!0,{})}}]);