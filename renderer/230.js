(global.webpackChunkxmind_vana=global.webpackChunkxmind_vana||[]).push([[230],{25918:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>o});var i=a(23645),n=a.n(i)()((function(e){return e[1]}));n.push([e.id,".outliner-audio-bar {\n  margin-top: 24px;\n  width: 248px;\n  height: 52px;\n  z-index: 1;\n  border-radius: 8px;\n}\n.audio-btn {\n  width: 40px;\n  height: 40px;\n  background: unset;\n}\n",""]);const o=n},10915:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>o});var i=a(23645),n=a.n(i)()((function(e){return e[1]}));n.push([e.id,".branch-only-bar[data-v-16541526] {\n  position: absolute;\n  left: 20px;\n  top: 20px;\n  z-index: 1;\n  border: none;\n}\n",""]);const o=n},92774:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>o});var i=a(23645),n=a.n(i)()((function(e){return e[1]}));n.push([e.id,".outliner-mode-container[data-v-03c49858] {\n  outline: none;\n}\n",""]);const o=n},68303:(e,t,a)=>{"use strict";a.d(t,{Z:()=>l});var i=a(75644);const n=(0,a(23352).ZP)("mp3recorder"),o=0,r=1,u=2;const l=class{constructor(e,t){t=t||{},this.sampleRate=t.sampleRate||44100,this.bufferSize=t.bufferSize||4096,this.kbps=t.kbps||128,this._mp3Data=[],this._stream=e,this.state=o,this.isEmpty=!0,this.data=null}start(){if(this.state!==o)return;this.state=r;let e=new(window.AudioContext||window.webkitAudioContext);this._context=e;let t=e.createMediaStreamSource(this._stream);this.audioInput=t,this.encoder=new i.d(1,e.sampleRate,this.kbps||128);let a=e.createScriptProcessor(this.bufferSize,1,1);a.onaudioprocess=e=>{if(this.state===r){let t=e.inputBuffer.getChannelData(0);t.filter((e=>0!==e)).length>0&&(this.isEmpty=!1);for(let e=0;e<t.length;e+=1152){let a=Math.min(t.length-e,1152),i=new ArrayBuffer(2*a),n=new DataView(i),o=0,r=0,u=0;for(;u<a;++u,o+=2)r=Math.max(-1,Math.min(1,t[e+u])),n.setInt16(o,r<0?32768*r:32767*r,!0);let l=this.encoder.encodeBuffer(new Int16Array(n.buffer));l.length>0&&this._mp3Data.push(l)}}},t.connect(a),a.connect(e.destination)}pause(){this.state===r&&(this.state=u)}resume(){this.state===u&&(this.state=r)}stop(){if(this.state===o)return;this.state=o;let e=this.encoder.flush();e.length>0&&this._mp3Data.push(new Int8Array(e)),this.data=new Blob(this._mp3Data,{type:"audio/mp3"}),this.audioInput.disconnect(),this.audioInput=null;try{let e=this._stream.getAudioTracks();for(let t of e)t.stop();this._stream=null}catch(e){n.warn("Error while stopping mp3 recording:",e)}this._context.close(),this._context=null}}},10230:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>k});var i=a(2954),n=a(87141),o=a(48825),r=a(18264),u=a(14474),l=a(69931),s=a(13382),d=a(18621),c=a(94593),p=a(68303),v=a(84374),h=a(70245);const m=(0,i.aZ)({__name:"audio-bar",setup(e){const t=(0,n.JE)().T,{outlinerState:a,updateOutlinerState:o,handleOutlinerOperation:r}=(0,h.p)(),{document:u,changeDoc:m,getResourceUrlByXapUrl:g,createXapUrlByArrayBuffer:f}=(0,v.nZ)(),y=(0,i.iH)(""),_=(0,i.iH)(null),b=(0,i.iH)(null),k=(0,i.iH)(null),x=(0,i.iH)(null),w=(0,i.iH)("00 : 00 : 00"),B=(0,i.iH)("00 : 00 : 00"),S=(0,i.iH)(0),A=(0,i.iH)(!1),T=(0,i.iH)(!1),M=(0,i.iH)(""),I=(0,i.Fl)((()=>a.value.audioBarMode)),C=(0,i.Fl)((()=>""!==I.value)),O=(0,i.Fl)((()=>""===y.value&&"audio_record"===a.value.audioBarMode&&0===a.value.selectionIds.length&&!a.value.currEditingTopicId)),D=(0,i.Fl)((()=>(0,n.S)().appearance)),P=(0,i.Fl)((()=>{let e="";switch(y.value){case"recording":e=`audio-stop@${D.value}`;break;case"playing":e=`audio-pause@${D.value}`;break;case"recordCompleted":case"paused":case"ended":e=`audio-play@${D.value}`;break;default:e=O.value?"audio-disabled":"audio-default"}return(0,l.ju)(`static/assets/images/audio/${e}.svg`)})),R=async()=>{if(b.value){const e=a.value.currEditingTopicId;if(!e)return;const t=a.value.topicItems.find((t=>t.topicId===e)),n=(new Date).toLocaleString();r({type:"add",parentTopicId:t.topicId,targetIndex:t.children.length,title:n,callback:async({newTopicId:e})=>{M.value=e,o({selectionIds:[e]})}}),await(0,i.Y3)(),b.value.start(),y.value="recording",o({audioRecording:!0}),F(),(0,d.L9)({eventCategory:"WorkBench",eventAction:"recordAudio"})}},F=()=>{J();const e=(new Date).getTime();k.value=setInterval((()=>{B.value=X(Date.now()-e)}),1e3)},E=({closeAfterDone:e=!1}={})=>{A.value=!0,J(),setTimeout((()=>{B.value="00 : 00 : 00"}),0),T.value=e,o({audioRecording:!1}),b.value&&(b.value.stop(),b.value.isEmpty?(r({type:"delete",topicId:a.value.selectionIds[0]}),L(),(0,s.N0)({type:"error",title:"Recording Failed",message:t("Recording Failed"),detail:t("This could be because that Xmind does not have permission to access microphone or microphone does not work properly."),buttons:[t("OK")]})):Z(b.value.data))},Z=async e=>{var t,a;const i=await e.arrayBuffer();if(i){const e=await f(i,".mp3"),n=null===(t=u.value.query({id:M.value}))||void 0===t?void 0:t.asTopic();if(n){const t=null!==(a=null==n?void 0:n.title)&&void 0!==a?a:"",i=v.HG.changeAudioNotesFor(u.value,M.value,{title:t,resourcePath:e.substring(4)});i&&m(i.ownerDocument)}!T.value&&setTimeout((()=>{o({audioBarMode:"audio_play",audioFilePath:n?e:"",audioAutoPlay:!1})}),10)}T.value&&L()},J=()=>{k.value&&(clearInterval(k.value),k.value=null)},N=()=>{x.value&&(clearInterval(x.value),x.value=null)},H=()=>{navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((e=>{b.value=new p.Z(e)})).catch((()=>{L(),(0,s.N0)({type:"error",title:"Xmind",message:t("Audio Note is Disabled"),detail:t("Audio note is disabled because no recorder device is detected."),buttons:[t("OK")]})}))},L=()=>{J(),B.value="00 : 00 : 00",y.value="",o({audioBarMode:"",audioFilePath:"",audioAutoPlay:!1})},$=()=>{try{_.value.pause()}catch(e){L()}_.value.removeAttribute("src"),_.value.load()},z=async()=>{const e=a.value.audioFilePath;if(e&&c.Z.existsSync(e))return e;const t=a.value.currEditingTopicId;if(!t)return;const i=a.value.topicItems.find((e=>e.topicId===t));if(!i)return;return await g(i.audioNotes)},U=e=>("0"+e).slice(-2),X=e=>{if(Number.isNaN(e)||!Number.isFinite(e)||e<0)return"00 : 00 : 00";let t=Math.floor(e/1e3),a=Math.floor(t/60);t%=60;let i=Math.floor(a/60);return a%=60,`${U(i)} : ${U(a)} : ${U(t)}`},Y=(e=!1)=>{if(_.value){const t=_.value.currentTime;w.value=X(1e3*(e?S.value:S.value-t))}},V=()=>{J(),_.value&&(k.value=setInterval((()=>{w.value=X(1e3*(S.value-_.value.currentTime))}),1e3))},j=e=>{switch(e){case"play":y.value="playing",Y(),V();break;case"pause":y.value="paused",N(),Y();break;case"ended":y.value="ended",N(),Y(!0)}},q=(e,t)=>{const a=new Audio(e);return a.autoplay=t,a.preload="auto",a.addEventListener("play",(()=>{j("play")})),a.addEventListener("pause",(()=>{j("pause")})),a.addEventListener("ended",(()=>{j("ended")})),a.addEventListener("error",(e=>{console.log("Error "+a.error.code+"; details: "+a.error.message)})),a},G=async()=>{const e=await z();e?(a.value.audioAutoPlay?y.value="playing":y.value="ended",_.value?(_.value.src=e,_.value.autoplay=a.value.audioAutoPlay):_.value=q(e,a.value.audioAutoPlay)):L(),W(e,(()=>{setTimeout((()=>{Y(!0)}),10)}))},K=()=>{"recording"===y.value?E({closeAfterDone:!0}):"playing"===y.value?($(),L()):L()},W=(e,t)=>{const a=new Audio(e);a.addEventListener("durationchange",(e=>{a.duration!=1/0&&(S.value=a.duration,a.remove(),t())}),!1),a.load(),a.currentTime=86400,a.volume=0;const i=a.play();i&&i.then((()=>{a.pause()}))};let Q;return(0,i.YP)((()=>I.value),(e=>{switch(A.value=!1,e){case"audio_record":_.value&&($(),J(),B.value="00 : 00 : 00",y.value=""),H();break;case"audio_play":G();break;case"open_new_audio_play":_.value&&(J(),B.value="00 : 00 : 00",y.value=""),G()}}),{immediate:!0}),(0,i.bv)((()=>{Q=(0,i.YP)(u,(()=>{if(!M.value)return;u.value.query({id:M.value})||K()}))})),(0,i.Jd)((()=>{K(),Q&&Q()})),{__sfc:!0,$T:t,outlinerState:a,updateOutlinerState:o,handleOutlinerOperation:r,document:u,changeDoc:m,getResourceUrlByXapUrl:g,createXapUrlByArrayBuffer:f,audioStatus:y,audio:_,audioRecorder:b,recordTimer:k,playerTimer:x,playerTimeString:w,recordTimeString:B,audioDuration:S,isSaving:A,isCloseAfterDone:T,audioTopicId:M,audioBarMode:I,isAudioBarVisible:C,isRecordDisabled:O,appearance:D,audioBarIcon:P,startRecord:R,resumeRecordTimer:F,doneRecord:E,saveAudio:Z,handleRecord:()=>{O.value&&A.value||("recording"!==y.value?R():E())},handlePlay:()=>{_.value&&(_.value.paused?_.value.play().catch((()=>{K()})):_.value.pause())},clearRecordTimer:J,clearPlayerTimer:N,initMediaDevices:H,closeAudioBarAndReset:L,resetAudioSrc:$,getAudioFilePath:z,formatNumberWithTwoDigit:U,toTimeString:X,playerTimeRemaining:Y,resumePlayerTimer:V,handleAudioStateChange:j,createAudio:q,prepareAudio:G,closeAudioBar:K,getDuration:W,unwatch:Q}}});a(45505);var g=a(51900);const f=(0,g.Z)(m,(function(){var e=this,t=e._self._c,a=e._self._setupProxy;return a.isAudioBarVisible?t("div",{staticClass:"uk-position-absolute uk-position-top-center uk-box-shadow-floating uk-background-default outliner-audio-bar"},[t("div",{staticClass:"uk-flex uk-flex-middle uk-height-1-1 uk-width-1-1"},["audio_record"===a.audioBarMode?t("div",{staticClass:"uk-flex uk-flex-middle uk-flex-row uk-height-1-1 uk-width-expand uk-margin-left"},[t("button",{staticClass:"vk-button-tile uk-margin-small-right uk-padding-remove audio-btn",on:{click:a.handleRecord}},[t("img",{staticClass:"uk-preserve",staticStyle:{width:"32px",height:"32px"},attrs:{draggable:"false","uk-svg":"",src:a.audioBarIcon}})]),e._v(" "),t("div",{staticStyle:{"font-size":"18px"}},[e._v("\n        "+e._s(a.recordTimeString)+"\n      ")])]):e._e(),e._v(" "),"audio_play"===a.audioBarMode||"open_new_audio_play"===a.audioBarMode?t("div",{staticClass:"uk-flex uk-flex-middle uk-flex-row uk-height-1-1 uk-width-expand uk-margin-left"},[t("button",{staticClass:"vk-button-tile uk-margin-right audio-btn",on:{click:a.handlePlay}},[t("img",{staticClass:"uk-preserve",staticStyle:{width:"32px",height:"32px"},attrs:{draggable:"false","uk-svg":"",src:a.audioBarIcon}})]),e._v(" "),t("div",{staticStyle:{"font-size":"18px"}},[e._v("\n        "+e._s(a.playerTimeString)+"\n      ")])]):e._e(),e._v(" "),t("button",{staticClass:"vk-button-tile uk-margin-right",staticStyle:{width:"24px",height:"24px"},attrs:{"uk-icon":"close"},on:{click:a.closeAudioBar}})])]):e._e()}),[],!1,null,null,null).exports;const y=(0,i.aZ)({__name:"branch-only-bar",emits:["exit"],setup:(e,{emit:t})=>({__sfc:!0,emit:t,handleClick:()=>{t("exit")}})});a(12833);const _=(0,g.Z)(y,(function(){var e=this,t=e._self._c;return t("div",{staticClass:"branch-only-bar"},[t("button",{staticClass:"vk-button-secondary vk-size-small",on:{click:e._self._setupProxy.handleClick}},[t("span",{attrs:{"uk-icon":"icon: arrow-left"}}),e._v(" "),t("span",{staticStyle:{"margin-left":"var(--spacing-margin-xxs)"}},[e._v(e._s(e.$T("Show Full Content")))])])])}),[],!1,null,"16541526",null).exports,b=(0,i.aZ)({__name:"outliner",setup(e){const{outlinerSheetModel:t,handleOutlinerOperation:a,outlinerState:l,updateOutlinerState:s,openOutlinerCtxMenu:d,unregisterOutliner:c,maxTopicsLoopNum:p}=(0,o.dI)(),{registerCommands:v,unregisterCommands:h}=(0,o.Qp)();(0,i.JJ)("handleOutlinerOperation",a),(0,i.JJ)("outlinerState",l),(0,i.JJ)("updateOutlinerState",s),(0,i.JJ)("outlinerActions",o.xI),(0,i.JJ)("openOutlinerCtxMenu",d);const m=(0,i.Fl)((()=>l.value.isBranchOnlyMode));return(0,i.YP)((()=>(0,r.U)().isFocusMissing),(e=>{e&&setTimeout((()=>{const e=(0,o.Gj)((0,o.dI)().outlinerState.value.currEditingTopicId);e&&e.focus()}),60)})),(0,i.bv)((()=>{v()})),(0,i.Jd)((()=>{h(),c()})),{__sfc:!0,outlinerSheetModel:t,handleOutlinerOperation:a,outlinerState:l,updateOutlinerState:s,openOutlinerCtxMenu:d,unregisterOutliner:c,maxTopicsLoopNum:p,registerCommands:v,unregisterCommands:h,isBranchOnlyMode:m,exitBranchOnlyMode:()=>{(0,n.JX)().handleCommand("editor.exitBranchOnly")},OutlinerMode:u.Z,AudioBar:f,BranchOnlyBar:_}}});a(51916);const k=(0,g.Z)(b,(function(){var e=this,t=e._self._c,a=e._self._setupProxy;return t("div",{staticClass:"outliner-mode-container uk-position-cover uk-flex uk-flex-column uk-overflow-hidden vk-scrollbar",attrs:{tabindex:"-1"}},[a.isBranchOnlyMode?t(a.BranchOnlyBar,{on:{exit:a.exitBranchOnlyMode}}):e._e(),e._v(" "),t(a.AudioBar),e._v(" "),t(a.OutlinerMode,e._b({},"outliner-mode",{outlinerSheetModel:a.outlinerSheetModel,maxTopicsLoopNum:a.maxTopicsLoopNum},!1))],1)}),[],!1,null,"03c49858",null).exports},45505:(e,t,a)=>{var i=a(25918);i.__esModule&&(i=i.default),"string"==typeof i&&(i=[[e.id,i,""]]),i.locals&&(e.exports=i.locals);(0,a(45346).Z)("e89d21d0",i,!0,{})},12833:(e,t,a)=>{var i=a(10915);i.__esModule&&(i=i.default),"string"==typeof i&&(i=[[e.id,i,""]]),i.locals&&(e.exports=i.locals);(0,a(45346).Z)("9da9c6d8",i,!0,{})},51916:(e,t,a)=>{var i=a(92774);i.__esModule&&(i=i.default),"string"==typeof i&&(i=[[e.id,i,""]]),i.locals&&(e.exports=i.locals);(0,a(45346).Z)("a7bf4de6",i,!0,{})}}]);